- name: Build Docker image and run container
  hosts: docker_hosts
  become: true
  vars:
    registry: "docker.io/pratibha2830"   
    app_name: "igpapp"                  
    image_tag: "{{ lookup('env','BUILD_NUMBER') | default('latest') }}"
    container_name: "igpapp-container"
    container_port: 8080                 
    host_port: 8080                      

  tasks:
    - name: Build Docker image
      community.docker.docker_image:
        name: "{{ registry }}/{{ app_name }}"
        tag: "{{ image_tag }}"
        build:
          path: ./        
        push: false       
      register: built

    - name: Remove old container if exists
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent

    - name: Run container from built image
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ registry }}/{{ app_name }}:{{ image_tag }}"
        state: started
        restart_policy: always
        published_ports:
          - "{{ host_port }}:{{ container_port }}"
